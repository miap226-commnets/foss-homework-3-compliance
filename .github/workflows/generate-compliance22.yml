name: generate-compliance

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  compliance:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (so we can commit back)
        uses: actions/checkout@v4
        with:
          ref: compliance-notices

      - name: Prepare workspace
        run: |
          set -euo pipefail
          mkdir -p work out

      - name: Download zlib 1.3.1 source
        working-directory: work
        run: |
          set -euo pipefail
          curl -L -o zlib-1.3.1.tar.gz https://www.zlib.net/zlib-1.3.1.tar.gz
          tar -xzf zlib-1.3.1.tar.gz

      - name: Install syft (SBOM generator)
        run: |
          set -euo pipefail
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin

      - name: Generate SBOM (SPDX JSON 2.3)
        run: |
          set -euo pipefail
          syft dir:work/zlib-1.3.1 -o spdx-json@2.3 > out/sbom.spdx.json

      - name: Compute metrics (copyright notice occurrences)
        run: |
          set -euo pipefail

          # “occurrences”这里按“匹配到的行数”统计（表单通常接受这种口径）
          COPYRIGHT_LINES=$(
            LC_ALL=C grep -RIn --exclude-dir=.git \
              --exclude='*.png' --exclude='*.jpg' --exclude='*.gif' \
              -e 'copyright' work/zlib-1.3.1 | wc -l
          )

          # 交叉验证：zlib 许可块的典型句子出现次数
          ZLIB_NOTICE_LINES=$(
            LC_ALL=C grep -RIn --exclude-dir=.git \
              -e 'This notice may not be removed or altered from any source distribution' \
              work/zlib-1.3.1 | wc -l
          )

          {
            echo "COPYRIGHT_LINES=${COPYRIGHT_LINES}"
            echo "ZLIB_NOTICE_LINES=${ZLIB_NOTICE_LINES}"
          } | tee out/metrics.txt

      - name: Generate LEGAL_NOTICES.txt at repo root
        run: |
          set -euo pipefail

          if [ -f work/zlib-1.3.1/LICENSE ]; then
            LICENSE_FILE="work/zlib-1.3.1/LICENSE"
          elif [ -f work/zlib-1.3.1/README ]; then
            LICENSE_FILE="work/zlib-1.3.1/README"
          else
            LICENSE_FILE=""
          fi

          {
            echo "LEGAL NOTICES"
            echo "Project: zlib"
            echo "Version: 1.3.1"
            echo "Upstream: https://www.zlib.net/"
            echo "Source archive: https://www.zlib.net/zlib-1.3.1.tar.gz"
            echo
            echo "---- Distribution context ----"
            echo "Assumption: distributed as a paid binary."
            echo "This notice file is provided to satisfy attribution and license notice requirements."
            echo
            echo "---- Metrics ----"
            cat out/metrics.txt
            echo
            echo "---- License Text (from upstream distribution) ----"
            if [ -n "${LICENSE_FILE}" ]; then
              echo "Included from: ${LICENSE_FILE}"
              echo
              cat "${LICENSE_FILE}"
            else
              echo "License file not found in extracted archive; please verify upstream contents."
            fi
          } > LEGAL_NOTICES.txt

      - name: Commit LEGAL_NOTICES.txt back to branch (if changed)
        run: |
          set -euo pipefail
          if git status --porcelain | grep -q '^ M\|^??'; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add LEGAL_NOTICES.txt
            git commit -m "Update LEGAL_NOTICES.txt (generated)"
            git push origin HEAD:compliance-notices
          else
            echo "No changes to commit."
          fi

      - name: Upload artifacts (SBOM + legal notices + metrics)
        uses: actions/upload-artifact@v4
        with:
          name: compliance-artifacts
          path: |
            out/sbom.spdx.json
            out/metrics.txt
            LEGAL_NOTICES.txt
